############################################
#       Christopher Gray
#       christophermjgray@gmail.com
#       https://raw.githubusercontent.com/c2theg/srvBuilds/master/site1_tls.conf
#
#       Initial:  7-21-08
#       Updated:  7-24-17
#       version   5.2.3
############################################

server {
    listen   443 ssl http2;	 # -- Many LB's do not currently support http2
    listen   [::]:443 ssl http2 ipv6only=on;
    
    #listen  443 ssl;
    #listen  [::]:443 ssl;

    server_name site.com;
    root /var/www;

    #-- local logging ---
    error_log   /var/log/nginx/error-ssl_site.com.log warn;
    access_log  /var/log/nginx/access-ssl_site.com.log json_access if=$loggable;
    
    #-- remote logging --  https://nginx.org/en/docs/syslog.html
    #error_log syslog:server=192.168.1.1:1514,facility=local7,tag=nginx-error-ssl-site.com,severity=info,nohostname warn;
    #access_log syslog:server=[2001:db8::1]:1514,facility=local7,tag=nginx-access-ssl-site.com,severity=info,nohostname json_access if=$loggable;
    
    index index.php index.html index.htm;
    #--------------------- SSL ---------------------------------
    ssl     on;
    ssl_certificate          /opt/ssl/server.crt;
    ssl_certificate_key      /opt/ssl/server.key;
    ssl_dhparam              /opt/ssl/server.pem;
    #ssl_trusted_certificate /opt/ssl/signed_server.crt;
    #--- Let's Encrypt ------
    #ssl_certificate /etc/letsencrypt/live/cgray.develop4.us/fullchain.pem;
    #ssl_certificate_key /etc/letsencrypt/live/cgray.develop4.us/privkey.pem;
    #--- End Let's Encrypt -----

    ssl_prefer_server_ciphers   on;
    ssl_ciphers 		        ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256;
    ssl_ecdh_curve              secp384r1; 
    ssl_protocols               TLSv1.2 TLSv1.3;

    ssl_session_timeout 5m;
    ssl_session_cache shared:SSL:60m;
    ssl_session_tickets off;
    add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";
    #add_header Public-Key-Pins 'pin-sha256="klO23nT2ehFDXCfx3eHTDRESMz3asj1muO+4aIdjiuY="; pin-sha256="633lt352PKRXbOwf4xSEa1M517scpD3l5f79xMD9r9Q="; max-age=2592000; includeS$

    #--- OCSP - Leave off for now. Still broken -------
    #ssl_stapling on;
    #ssl_stapling_verify on;
    resolver 8.8.4.4 8.8.8.8 208.67.222.222 valid=300s;
    resolver_timeout 5s;
    #----------------------------------------------------------
    charset     utf-8;
    large_client_header_buffers 4 32k;
    
    location / {
        try_files $uri $uri/ /index.html;
	#ModSecurityEnabled on;
	#ModSecurityConfig modsec_includes.conf;
	
	#---- Caching -----
        #proxy_pass             http://1.2.3.4;
        #proxy_set_header       Host $host;
        #proxy_cache            STATIC;
        #proxy_cache_valid      200  1d;
	
	#proxy_cache Zone_Local_Cache; #-- Enabling Caching
        #proxy_cache_revalidate on;
        #proxy_cache_min_uses 3;
        #proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        #proxy_cache_lock on;
    }

    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        # NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini

        fastcgi_pass    unix:/var/run/php/php7.0-fpm.sock;
	#fastcgi_pass   unix:/var/run/php/php5.6-fpm.sock;

        fastcgi_index   index.php;
        include         fastcgi_params;
        fastcgi_param   SCRIPT_FILENAME    $document_root$fastcgi_script_name;
        fastcgi_param   SCRIPT_NAME        $fastcgi_script_name;

        #fastcgi_param  REMOTE_ADDR        $http_x_forwarded_for;
        #fastcgi_param  REMOTE_ADDR        $http_x_real_ip;
        #fastcgi_param  REMOTE_ADDR        $http_x_forwarded_for;

        #---  Fixes the ability to forward ip address to PHP ---
        set_real_ip_from 127.0.0.1/32; 
        real_ip_header X-Forwarded-For;
        #-------------------------------------------------------
        fastcgi_connect_timeout         60;
        fastcgi_send_timeout            60;
        fastcgi_read_timeout            60;
        fastcgi_buffer_size             4k;
        fastcgi_buffers                         512 4k;
        fastcgi_busy_buffers_size   8k;
        fastcgi_temp_file_write_size  256k;
        # ----- Caching -----
        expires 300s;
        add_header Pragma "public";
        add_header Cache-Control "max-age=300, public, must-revalidate, proxy-revalidate";
        add_header X-Powered-By "A hamster on a wheel, drinking unicorn tears";
        uwsgi_param HTTP_IF_NONE_MATCH $http_if_none_match;
        uwsgi_param HTTP_IF_MODIFIED_SINCE $http_if_modified_since;
    }

    location ~* \.(js)$ {
        expires 600s;
        add_header Pragma "public";
        add_header Cache-Control "max-age=600, public, must-revalidate, proxy-revalidate";
        add_header X-Powered-By "Hamster on a wheel";
        access_log  off;
        log_not_found  off;
        uwsgi_param HTTP_IF_NONE_MATCH $http_if_none_match;
        uwsgi_param HTTP_IF_MODIFIED_SINCE $http_if_modified_since;
    }

    location ~* \.(css|html|htm)$ {
        expires 7200s;
        add_header Pragma "public";
        add_header Cache-Control "max-age=7200, public, must-revalidate, proxy-revalidate";
        add_header X-Powered-By "Hamster on a wheel";
        access_log  off;
        log_not_found  off;
        uwsgi_param HTTP_IF_NONE_MATCH $http_if_none_match;
        uwsgi_param HTTP_IF_MODIFIED_SINCE $http_if_modified_since;
    }

    location ~* \.(3gp|gif|jpg|jpeg|png|ico|wmv|avi|asf|asx|mpg|mpeg|mp4|pls|mp3|mid|wav|swf|flv|svg|bz2|tar|gz|zip|rar|ogg|woff|woff2|webm|webv)$ {
        expires 604800s; # a week
        add_header Pragma "public";
        add_header Cache-Control "max-age=604800, public, must-revalidate, proxy-revalidate";
        add_header X-Powered-By "Hamster on a wheel";
        access_log  off;
        log_not_found off;
        uwsgi_param HTTP_IF_NONE_MATCH $http_if_none_match;
        uwsgi_param HTTP_IF_MODIFIED_SINCE $http_if_modified_since;
    }

    # cache.appcache, your document data
    location ~* \.(?:manifest|appcache)$ {
        expires -1;
        # access_log logs/static.log; # I don't usually include a static log
    }
    
    # Feeds
    location ~* \.(?:rss|atom)$ {
        expires 1h;
        add_header Cache-Control "public";
    }
    
    # API data
    location ~* \.(?:xml|json)$ {
        expires 5m;
        add_header Cache-Control "public";	
    }

    # block files
    location ~* \.(?:txt|TXT|conf|doc|xls|ppt|docx|xlsx|pptx|dump|sql|bak|bk)$ {
        return 403;
    }
    
    #---------- Error pages ------------
    error_page 404 /40x.html;
    location = /40x.html {
        root /var/www;
        internal;
    }
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /var/www;
	internal;
    }

    location ~ /\.ht { deny all; access_log off; log_not_found off; }
    #-------------------- Security ------------------------------------------
    add_header                      X-Frame-Options SAMEORIGIN;
    add_header                      X-Content-Type-Options nosniff;
    add_header                      X-XSS-Protection "1; mode=block";
}


#server {
#        listen      80;
#        server_name  site.com;
#        rewrite     ^   https://$server_name$request_uri? permanent;
#        location ~ /\.ht { deny all; access_log off; log_not_found off; }
#        add_header Strict-Transport-Security max-age=15768000;
#}

#proxy non-secure webserver or app
#server {
#   listen 443;
#   server_name insideapp.site.com;
#   #auth_basic "Restricted Access";
#   #auth_basic_user_file /etc/nginx/htpasswd.users;

#   location / {
#       proxy_pass http://localhost:5601;
#       proxy_http_version 1.1;
#       proxy_set_header Upgrade $http_upgrade;
#       proxy_set_header Connection 'upgrade';
#       proxy_set_header Host $host;
#       proxy_cache_bypass $http_upgrade;
#   }
#}
